<xmod:ScriptBlock BlockType="HeadScript" ScriptId="UG_201503_Style" RegisterOnce="true">
	<link href="/usergroup/2015/03/css/style.css" rel="stylesheet" type="text/css" />
    <!--Wijmo Widgets CSS-->
    <link href="http://cdn.wijmo.com/themes/rocket/jquery-wijmo.css" rel="stylesheet" type="text/css" />
    <link href="http://cdn.wijmo.com/jquery.wijmo-pro.all.3.20131.7.min.css" rel="stylesheet" type="text/css" />
    
    <!--Wijmo Widgets JavaScript-->
    <script src="http://cdn.wijmo.com/jquery.wijmo-open.all.3.20131.7.min.js" type="text/javascript"></script>
    <script src="http://cdn.wijmo.com/jquery.wijmo-pro.all.3.20131.7.min.js" type="text/javascript"></script>
</xmod:ScriptBlock>


<div class="row">
  <div class="col-md-4">
    <div class="input-group">
      <input type="text" id="query-input" class="form-control" placeholder="Search" />
      <span id="submit-query" class="input-group-addon btn btn-success"><i class="fa fa-search"></i></span>
      <span id="query-clear" class="input-group-addon btn"><i class="fa fa-refresh"></i></span>
    </div>
  </div>
</div>

<div class="apps-pager">

</div>
<table class="gray">
  <thead>
    <tr>
      <th><a href="#" data-colname="1">Contact Id</a></th>
      <th><a href="#" data-colname="2">Contact Type</a></th>
      <th><a href="#" data-colname="3">First Name</a></th>
      <th><a href="#" data-colname="4">Last Name</a></th>
      <th><a href="#" data-colname="5">Email</a></th>
      <th><a href="#" data-colname="6">Gender</a></th>
      <th><a href="#" data-colname="7">Address1</a></th>
      <th><a href="#" data-colname="8">City</a></th>
    </tr>
  </thead>
  <tbody data-bind="foreach: contacts.list">
    <tr>
      <td data-bind="text: contactId"></td>
      <td data-bind="text: contactType"></td>
      <td data-bind="text: firstName"></td>
      <td data-bind="text: lastName"></td>
      <td data-bind="text: email"></td>
      <td data-bind="text: gender"></td>
      <td data-bind="text: address1"></td>
      <td data-bind="text: city"></td>
    </tr>
  </tbody>
</table>

<div class="pager-container">
	<div class="apps-pager bottom"></div>
  <label for="page-size">Page Size: </label>
  <select size="1" id="page-size">
    <option value="10" selected>10</option>
    <option value="25">25</option>
    <option value="50">50</option>
    <option value="100">100</option>
  </select>
</div>


<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script src="http://ajax.aspnetcdn.com/ajax/knockout/knockout-2.2.1.js" type="text/javascript"></script>

<script>
	// Using KnockoutJS - setup view model
  var contact = function() {
  	var _self = this;
    _self.contactId			= ko.observable("");
    _self.contactType		= ko.observable("");
    _self.firstName			= ko.observable("");
    _self.lastName			= ko.observable("");
    _self.email					= ko.observable("");
    _self.gender				= ko.observable("");
    _self.address1			= ko.observable("");
    _self.city					= ko.observable("");
  }
  
  var contactsList = function(items) {
  	var _self = this;
    _self.list = ko.observableArray(items);
  }

 	var contacts = new contactsList([]);
  var contactsPageCount = 0;
</script>


<xmod:jQueryReady>
  var _feedUrl = '/desktopmodules/XModPro/Feed.aspx?pid=0&xfd=';
  
  // get initial display of data
  getRecords(1, function() {
    ko.applyBindings(contacts);
  });
  

  
  // use AJAX to retrieve records with filtering/sorting via feed
  function getRecords(pageNum, cb) {
    var feedUrl = _feedUrl + 'getContacts';
    // get search/sort values, if any
    var query = $('#query-input').val();
    var sortOn = 1;
    var sortDesc = 1;
    var pageSize = parseInt($('#page-size').val());
    var $tableHead = $('table.gray:first thead tr');
    var $sortCol = $tableHead.find('th span.sortup:first, th span.sortdown:first');
    if ($sortCol.length > 0) {
      sortOn = parseInt($sortCol.parent().find('a:first').attr('data-colname'));
      if ($sortCol.hasClass('sortup')) {
				sortDesc = 0
      }
    }
    
    $.ajax({
      url: feedUrl,
      type: "POST", 
      dataType: "json", 
      data: {
        sortOn: sortOn,
        sortDesc: sortDesc, 
        query: query, 
        pageSize: pageSize, 
        pageNum: pageNum        
      }, 
      success: function(data) {
        var totalRecs = 0;
        var numOldItems = contacts.list().length;
        for (var j=0; j<numOldItems; j++) {
        	contacts.list.pop(); 
        }
        if (!data) {
          
        } else {
          if (data.length) {
            var curItem;
            for (var i=0; i<data.length; i++) {
              curItem = new contact();
              curItem.contactId = data[i].ContactId;
              curItem.contactType = data[i].ContactType;
              curItem.firstName = data[i].FirstName;
              curItem.lastName = data[i].LastName;
              curItem.email = data[i].Email;
              curItem.gender = data[i].Gender;
              curItem.address1 = data[i].Address1;
              curItem.city = data[i].City;
              contacts.list.push(curItem)
              totalRecs = data[i].TotalCount;
            }
          }
        } // if (!data)/else
  
        if (totalRecs > pageSize) {
          contactsPageCount = Math.ceil((totalRecs/pageSize));
  				
          $pagers.wijpager({
            pageCount: contactsPageCount, 
            pageIndex: pageNum - 1
          });
  				
        } else {
  				
          $pagers.wijpager({
            pageCount: 1,
            pageIndex: 1
          });
  				
        }
  
        if (cb) cb();
      }
    });
  }
  $('table.gray th a').click(function(e){
    e.preventDefault();
    var $lnk = $(this);
    var newOrder = 'sortup';
    if ($lnk.hasClass('sortup')) {
      newOrder = 'sortdown';
    }
    $lnk.parent().parent().find('a').removeClass('sortup sortdown');
    $lnk.parent().parent().find('span.sortup, span.sortdown').remove();
    $lnk.addClass(newOrder);
    $lnk.after('<span class="' + newOrder + '"></span>');
    getRecords(1); //$pagers.wijpager("option", "pageIndex") + 1);
  });
  var $pagers = $('div.apps-pager');
  
  $pagers.wijpager({
    pageCount: contactsPageCount, 
    pageIndex: 0,
    mode: 'numericFirstLast', 
    pageIndexChanged: function(e, args) {
      $pagers.append('<span class="loading-small"></span>');
      getRecords(args.newPageIndex + 1, function() {
        $pagers.find('span.loading-small').remove();
      }); 
    }
  });
  
  $('#submit-query').click(function(e){
    e.preventDefault();
    var $this = $(this);
    $this.parent().append('<span class="loading-small"></span>');
    getRecords(1, function() {
      $this.parent().find('span.loading-small').remove();
    });
  });
  $('#query-clear').click(function(e){
    e.preventDefault();
    var $this = $(this);
    $('#query-input').val('');
    $this.parent().append('<span class="loading-small"></span>');
    getRecords(1, function() {
      $this.parent().find('span.loading-small').remove();
    });
  });
  $('#page-size').change(function(e){
    var $this = $(this);
    $this.parent().append('<span class="loading-small"></span>');
    getRecords(1, function() {
      $this.parent().find('span.loading-small').remove();
    });
  });
 
</xmod:jQueryReady>